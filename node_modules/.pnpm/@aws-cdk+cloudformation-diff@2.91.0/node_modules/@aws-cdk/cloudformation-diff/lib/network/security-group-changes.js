"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SecurityGroupChanges = void 0;
const chalk = require("chalk");
const security_group_rule_1 = require("./security-group-rule");
const diffable_1 = require("../diffable");
const render_intrinsics_1 = require("../render-intrinsics");
const util_1 = require("../util");
/**
 * Changes to IAM statements
 */
class SecurityGroupChanges {
    constructor(props) {
        this.ingress = new diffable_1.DiffableCollection();
        this.egress = new diffable_1.DiffableCollection();
        // Group rules
        for (const ingressProp of props.ingressRulePropertyChanges) {
            this.ingress.addOld(...this.readInlineRules(ingressProp.oldValue, ingressProp.resourceLogicalId));
            this.ingress.addNew(...this.readInlineRules(ingressProp.newValue, ingressProp.resourceLogicalId));
        }
        for (const egressProp of props.egressRulePropertyChanges) {
            this.egress.addOld(...this.readInlineRules(egressProp.oldValue, egressProp.resourceLogicalId));
            this.egress.addNew(...this.readInlineRules(egressProp.newValue, egressProp.resourceLogicalId));
        }
        // Rule resources
        for (const ingressRes of props.ingressRuleResourceChanges) {
            this.ingress.addOld(...this.readRuleResource(ingressRes.oldProperties));
            this.ingress.addNew(...this.readRuleResource(ingressRes.newProperties));
        }
        for (const egressRes of props.egressRuleResourceChanges) {
            this.egress.addOld(...this.readRuleResource(egressRes.oldProperties));
            this.egress.addNew(...this.readRuleResource(egressRes.newProperties));
        }
        this.ingress.calculateDiff();
        this.egress.calculateDiff();
    }
    get hasChanges() {
        return this.ingress.hasChanges || this.egress.hasChanges;
    }
    /**
     * Return a summary table of changes
     */
    summarize() {
        const ret = [];
        const header = ['', 'Group', 'Dir', 'Protocol', 'Peer'];
        const inWord = 'In';
        const outWord = 'Out';
        // Render a single rule to the table (curried function so we can map it across rules easily--thank you JavaScript!)
        const renderRule = (plusMin, inOut) => (rule) => [
            plusMin,
            rule.groupId,
            inOut,
            rule.describeProtocol(),
            rule.describePeer(),
        ].map(s => plusMin === '+' ? chalk.green(s) : chalk.red(s));
        // First generate all lines, sort later
        ret.push(...this.ingress.additions.map(renderRule('+', inWord)));
        ret.push(...this.egress.additions.map(renderRule('+', outWord)));
        ret.push(...this.ingress.removals.map(renderRule('-', inWord)));
        ret.push(...this.egress.removals.map(renderRule('-', outWord)));
        // Sort by group name then ingress/egress (ingress first)
        ret.sort((0, util_1.makeComparator)((row) => [row[1], row[2].indexOf(inWord) > -1 ? 0 : 1]));
        ret.splice(0, 0, header);
        return ret;
    }
    toJson() {
        return (0, util_1.deepRemoveUndefined)({
            ingressRuleAdditions: (0, util_1.dropIfEmpty)(this.ingress.additions.map(s => s.toJson())),
            ingressRuleRemovals: (0, util_1.dropIfEmpty)(this.ingress.removals.map(s => s.toJson())),
            egressRuleAdditions: (0, util_1.dropIfEmpty)(this.egress.additions.map(s => s.toJson())),
            egressRuleRemovals: (0, util_1.dropIfEmpty)(this.egress.removals.map(s => s.toJson())),
        });
    }
    get rulesAdded() {
        return this.ingress.hasAdditions
            || this.egress.hasAdditions;
    }
    readInlineRules(rules, logicalId) {
        if (!rules) {
            return [];
        }
        // UnCloudFormation so the parser works in an easier domain
        const ref = '${' + logicalId + '.GroupId}';
        return rules.map((r) => new security_group_rule_1.SecurityGroupRule((0, render_intrinsics_1.renderIntrinsics)(r), ref));
    }
    readRuleResource(resource) {
        if (!resource) {
            return [];
        }
        // UnCloudFormation so the parser works in an easier domain
        return [new security_group_rule_1.SecurityGroupRule((0, render_intrinsics_1.renderIntrinsics)(resource))];
    }
}
exports.SecurityGroupChanges = SecurityGroupChanges;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHktZ3JvdXAtY2hhbmdlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlY3VyaXR5LWdyb3VwLWNoYW5nZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBQy9CLCtEQUFvRTtBQUVwRSwwQ0FBaUQ7QUFDakQsNERBQXdEO0FBQ3hELGtDQUEyRTtBQVMzRTs7R0FFRztBQUNILE1BQWEsb0JBQW9CO0lBSS9CLFlBQVksS0FBZ0M7UUFINUIsWUFBTyxHQUFHLElBQUksNkJBQWtCLEVBQXFCLENBQUM7UUFDdEQsV0FBTSxHQUFHLElBQUksNkJBQWtCLEVBQXFCLENBQUM7UUFHbkUsY0FBYztRQUNkLEtBQUssTUFBTSxXQUFXLElBQUksS0FBSyxDQUFDLDBCQUEwQixFQUFFO1lBQzFELElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7WUFDbEcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztTQUNuRztRQUNELEtBQUssTUFBTSxVQUFVLElBQUksS0FBSyxDQUFDLHlCQUF5QixFQUFFO1lBQ3hELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7WUFDL0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztTQUNoRztRQUVELGlCQUFpQjtR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QUFJLENBQUMsS0FBSyxFQUFFO1lBQUUsT0FBTyxFQUFFLENBQUM7U0FBRTtRQUUxQiwyREFBMkQ7UUFFM0QsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLFNBQVMsR0FBRyxXQUFXLENBQUM7UUFDM0MsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLHVDQUFpQixDQUFDLElBQUEsb0NBQWdCLEVBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNoRixDQUFDO0lBRU8sZ0JBQWdCLENBQUMsUUFBYTtRQUNwQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQUUsT0FBTyxFQUFFLENBQUM7U0FBRTtRQUU3QiwyREFBMkQ7UUFFM0QsT0FBTyxDQUFDLElBQUksdUNBQWlCLENBQUMsSUFBQSxvQ0FBZ0IsRUFBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0QsQ0FBQztDQUNGO0FBakdELG9EQWlHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCB7IFJ1bGVKc29uLCBTZWN1cml0eUdyb3VwUnVsZSB9IGZyb20gJy4vc2VjdXJpdHktZ3JvdXAtcnVsZSc7XG5pbXBvcnQgeyBQcm9wZXJ0eUNoYW5nZSwgUmVzb3VyY2VDaGFuZ2UgfSBmcm9tICcuLi9kaWZmL3R5cGVzJztcbmltcG9ydCB7IERpZmZhYmxlQ29sbGVjdGlvbiB9IGZyb20gJy4uL2RpZmZhYmxlJztcbmltcG9ydCB7IHJlbmRlckludHJpbnNpY3MgfSBmcm9tICcuLi9yZW5kZXItaW50cmluc2ljcyc7XG5pbXBvcnQgeyBkZWVwUmVtb3ZlVW5kZWZpbmVkLCBkcm9wSWZFbXB0eSwgbWFrZUNvbXBhcmF0b3IgfSBmcm9tICcuLi91dGlsJztcblxuZXhwb3J0IGludGVyZmFjZSBTZWN1cml0eUdyb3VwQ2hhbmdlc1Byb3BzIHtcbiAgaW5ncmVzc1J1bGVQcm9wZXJ0eUNoYW5nZXM6IFByb3BlcnR5Q2hhbmdlW107XG4gIGluZ3Jlc3NSdWxlUmVzb3VyY2VDaGFuZ2VzOiBSZXNvdXJjZUNoYW5nZVtdO1xuICBlZ3Jlc3NSdWxlUmVzb3VyY2VDaGFuZ2VzOiBSZXNvdXJjZUNoYW5nZVtdO1xuICBlZ3Jlc3NSdWxlUHJvcGVydHlDaGFuZ2VzOiBQcm9wZXJ0eUNoYW5nZVtdO1xufVxuXG4vKipcbiAqIENoYW5nZXMgdG8gSUFNIHN0YXRlbWVudHNcbiAqL1xuZXhwb3J0IGNsYXNzIFNlY3VyaXR5R3JvdXBDaGFuZ2VzIHtcbiAgcHVibGljIHJlYWRvbmx5IGluZ3Jlc3MgPSBuZXcgRGlmZmFibGVDb2xsZWN0aW9uPFNlY3VyaXR5R3JvdXBSdWxlPigpO1xuICBwdWJsaWMgcmVhZG9ubHkgZWdyZXNzID0gbmV3IERpZmZhYmxlQ29sbGVjdGlvbjxTZWN1cml0eUdyb3VwUnVsZT4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogU2VjdXJpdHlHcm91cENoYW5nZXNQcm9wcykge1xuICAgIC8vIEdyb3VwIHJ1bGVzXG4gICAgZm9yIChjb25zdCBpbmdyZXNzUHJvcCBvZiBwcm9wcy5pbmdyZXNzUnVsZVByb3BlcnR5Q2hhbmdlcykge1xuICAgICAgdGhpcy5pbmdyZXNzLmFkZE9sZCguLi50aGlzLnJlYWRJbmxpbmVSdWxlcyhpbmdyZXNzUHJvcC5vbGRWYWx1ZSwgaW5ncmVzc1Byb3AucmVzb3VyY2VMb2dpY2FsSWQpKTtcbiAgICAgIHRoaXMuaW5ncmVzcy5hZGROZXcoLi4udGhpcy5yZWFkSW5saW5lUnVsZXMoaW5ncmVzc1Byb3AubmV3VmFsdWUsIGluZ3Jlc3NQcm9wLnJlc291cmNlTG9naWNhbElkKSk7XG4gICAgfVxuICAgIGZvciAoY29uc3QgZWdyZXNzUHJvcCBvZiBwcm9wcy5lZ3Jlc3NSdWxlUHJvcGVydHlDaGFuZ2VzKSB7XG4gICAgICB0aGlzLmVncmVzcy5hZGRPbGQoLi4udGhpcy5yZWFkSW5saW5lUnVsZXMoZWdyZXNzUHJvcC5vbGRWYWx1ZSwgZWdyZXNzUHJvcC5yZXNvdXJjZUxvZ2ljYWxJZCkpO1xuICAgICAgdGhpcy5lZ3Jlc3MuYWRkTmV3KC4uLnRoaXMucmVhZElubGluZVJ1bGVzKGVncmVzc1Byb3AubmV3VmFsdWUsIGVncmVzc1Byb3AucmVzb3VyY2VMb2dpY2FsSWQpKTtcbiAgICB9XG5cbiAgICAvLyBSdWxlIHJlc291cmNlc1xuICAgIGZvciAoY29uc3QgaW5ncmVzc1JlcyBvZiBwcm9wcy5pbmdyZXNzUnVsZVJlc291cmNlQ2hhbmdlcykge1xuICAgICAgdGhpcy5pbmdyZXNzLmFkZE9sZCguLi50aGlzLnJlYWRSdWxlUmVzb3VyY2UoaW5ncmVzc1Jlcy5vbGRQcm9wZXJ0aWVzKSk7XG4gICAgICB0aGlzLmluZ3Jlc3MuYWRkTmV3KC4uLnRoaXMucmVhZFJ1bGVSZXNvdXJjZShpbmdyZXNzUmVzLm5ld1Byb3BlcnRpZXMpKTtcbiAgICB9XG4gICAgZm9yIChjb25zdCBlZ3Jlc3NSZXMgb2YgcHJvcHMuZWdyZXNzUnVsZVJlc291cmNlQ2hhbmdlcykge1xuICAgICAgdGhpcy5lZ3Jlc3MuYWRkT2xkKC4uLnRoaXMucmVhZFJ1bGVSZXNvdXJjZShlZ3Jlc3NSZXMub2xkUHJvcGVydGllcykpO1xuICAgICAgdGhpcy5lZ3Jlc3MuYWRkTmV3KC4uLnRoaXMucmVhZFJ1bGVSZXNvdXJjZShlZ3Jlc3NSZXMubmV3UHJvcGVydGllcykpO1xuICAgIH1cblxuICAgIHRoaXMuaW5ncmVzcy5jYWxjdWxhdGVEaWZmKCk7XG4gICAgdGhpcy5lZ3Jlc3MuY2FsY3VsYXRlRGlmZigpO1xuICB9XG5cbiAgcHVibGljIGdldCBoYXNDaGFuZ2VzKCkge1xuICAgIHJldHVybiB0aGlzLmluZ3Jlc3MuaGFzQ2hhbmdlcyB8fCB0aGlzLmVncmVzcy5oYXNDaGFuZ2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhIHN1bW1hcnkgdGFibGUgb2YgY2hhbmdlc1xuICAgKi9cbiAgcHVibGljIHN1bW1hcml6ZSgpOiBzdHJpbmdbXVtdIHtcbiAgICBjb25zdCByZXQ6IHN0cmluZ1tdW10gPSBbXTtcblxuICAgIGNvbnN0IGhlYWRlciA9IFsnJywgJ0dyb3VwJywgJ0RpcicsICdQcm90b2NvbCcsICdQZWVyJ107XG5cbiAgICBjb25zdCBpbldvcmQgPSAnSW4nO1xuICAgIGNvbnN0IG91dFdvcmQgPSAnT3V0JztcblxuICAgIC8vIFJlbmRlciBhIHNpbmdsZSBydWxlIHRvIHRoZSB0YWJsZSAoY3VycmllZCBmdW5jdGlvbiBzbyB3ZSBjYW4gbWFwIGl0IGFjcm9zcyBydWxlcyBlYXNpbHktLXRoYW5rIHlvdSBKYXZhU2NyaXB0ISlcbiAgICBjb25zdCByZW5kZXJSdWxlID0gKHBsdXNNaW46IHN0cmluZywgaW5PdXQ6IHN0cmluZykgPT4gKHJ1bGU6IFNlY3VyaXR5R3JvdXBSdWxlKSA9PiBbXG4gICAgICBwbHVzTWluLFxuICAgICAgcnVsZS5ncm91cElkLFxuICAgICAgaW5PdXQsXG4gICAgICBydWxlLmRlc2NyaWJlUHJvdG9jb2woKSxcbiAgICAgIHJ1bGUuZGVzY3JpYmVQZWVyKCksXG4gICAgXS5tYXAocyA9PiBwbHVzTWluID09PSAnKycgPyBjaGFsay5ncmVlbihzKSA6IGNoYWxrLnJlZChzKSk7XG5cbiAgICAvLyBGaXJzdCBnZW5lcmF0ZSBhbGwgbGluZXMsIHNvcnQgbGF0ZXJcbiAgICByZXQucHVzaCguLi50aGlzLmluZ3Jlc3MuYWRkaXRpb25zLm1hcChyZW5kZXJSdWxlKCcrJywgaW5Xb3JkKSkpO1xuICAgIHJldC5wdXNoKC4uLnRoaXMuZWdyZXNzLmFkZGl0aW9ucy5tYXAocmVuZGVyUnVsZSgnKycsIG91dFdvcmQpKSk7XG4gICAgcmV0LnB1c2goLi4udGhpcy5pbmdyZXNzLnJlbW92YWxzLm1hcChyZW5kZXJSdWxlKCctJywgaW5Xb3JkKSkpO1xuICAgIHJldC5wdXNoKC4uLnRoaXMuZWdyZXNzLnJlbW92YWxzLm1hcChyZW5kZXJSdWxlKCctJywgb3V0V29yZCkpKTtcblxuICAgIC8vIFNvcnQgYnkgZ3JvdXAgbmFtZSB0aGVuIGluZ3Jlc3MvZWdyZXNzIChpbmdyZXNzIGZpcnN0KVxuICAgIHJldC5zb3J0KG1ha2VDb21wYXJhdG9yKChyb3c6IHN0cmluZ1tdKSA9PiBbcm93WzFdLCByb3dbMl0uaW5kZXhPZihpbldvcmQpID4gLTEgPyAwIDogMV0pKTtcblxuICAgIHJldC5zcGxpY2UoMCwgMCwgaGVhZGVyKTtcblxuICAgIHJldHVybiByZXQ7XG4gIH1cblxuICBwdWJsaWMgdG9Kc29uKCk6IFNlY3VyaXR5R3JvdXBDaGFuZ2VzSnNvbiB7XG4gICAgcmV0dXJuIGRlZXBSZW1vdmVVbmRlZmluZWQoe1xuICAgICAgaW5ncmVzc1J1bGVBZGRpdGlvbnM6IGRyb3BJZkVtcHR5KHRoaXMuaW5ncmVzcy5hZGRpdGlvbnMubWFwKHMgPT4gcy50b0pzb24oKSkpLFxuICAgICAgaW5ncmVzc1J1bGVSZW1vdmFsczogZHJvcElmRW1wdHkodGhpcy5pbmdyZXNzLnJlbW92YWxzLm1hcChzID0+IHMudG9Kc29uKCkpKSxcbiAgICAgIGVncmVzc1J1bGVBZGRpdGlvbnM6IGRyb3BJZkVtcHR5KHRoaXMuZWdyZXNzLmFkZGl0aW9ucy5tYXAocyA9PiBzLnRvSnNvbigpKSksXG4gICAgICBlZ3Jlc3NSdWxlUmVtb3ZhbHM6IGRyb3BJZkVtcHR5KHRoaXMuZWdyZXNzLnJlbW92YWxzLm1hcChzID0+IHMudG9Kc29uKCkpKSxcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcnVsZXNBZGRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pbmdyZXNzLmhhc0FkZGl0aW9uc1xuICAgICAgICB8fCB0aGlzLmVncmVzcy5oYXNBZGRpdGlvbnM7XG4gIH1cblxuICBwcml2YXRlIHJlYWRJbmxpbmVSdWxlcyhydWxlczogYW55LCBsb2dpY2FsSWQ6IHN0cmluZyk6IFNlY3VyaXR5R3JvdXBSdWxlW10ge1xuICAgIGlmICghcnVsZXMpIHsgcmV0dXJuIFtdOyB9XG5cbiAgICAvLyBVbkNsb3VkRm9ybWF0aW9uIHNvIHRoZSBwYXJzZXIgd29ya3MgaW4gYW4gZWFzaWVyIGRvbWFpblxuXG4gICAgY29uc3QgcmVmID0gJyR7JyArIGxvZ2ljYWxJZCArICcuR3JvdXBJZH0nO1xuICAgIHJldHVybiBydWxlcy5tYXAoKHI6IGFueSkgPT4gbmV3IFNlY3VyaXR5R3JvdXBSdWxlKHJlbmRlckludHJpbnNpY3MociksIHJlZikpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWFkUnVsZVJlc291cmNlKHJlc291cmNlOiBhbnkpOiBTZWN1cml0eUdyb3VwUnVsZVtdIHtcbiAgICBpZiAoIXJlc291cmNlKSB7IHJldHVybiBbXTsgfVxuXG4gICAgLy8gVW5DbG91ZEZvcm1hdGlvbiBzbyB0aGUgcGFyc2VyIHdvcmtzIGluIGFuIGVhc2llciBkb21haW5cblxuICAgIHJldHVybiBbbmV3IFNlY3VyaXR5R3JvdXBSdWxlKHJlbmRlckludHJpbnNpY3MocmVzb3VyY2UpKV07XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBTZWN1cml0eUdyb3VwQ2hhbmdlc0pzb24ge1xuICBpbmdyZXNzUnVsZUFkZGl0aW9ucz86IFJ1bGVKc29uW107XG4gIGluZ3Jlc3NSdWxlUmVtb3ZhbHM/OiBSdWxlSnNvbltdO1xuICBlZ3Jlc3NSdWxlQWRkaXRpb25zPzogUnVsZUpzb25bXTtcbiAgZWdyZXNzUnVsZVJlbW92YWxzPzogUnVsZUpzb25bXTtcbn1cbiJdfQ==