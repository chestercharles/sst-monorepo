"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cannedMetricsForService = void 0;
const canned_metrics_schema_1 = require("./canned-metrics/canned-metrics-schema");
/**
 * Return the list of canned metrics for the given service
 */
function cannedMetricsForService(cloudFormationNamespace) {
    // One metricTemplate has a single set of dimensions, but the same metric NAME
    // may occur in multiple metricTemplates (if it has multiple sets of dimensions)
    const metricTemplates = cannedMetricsIndex()[cloudFormationNamespace] ?? [];
    // First construct almost what we need, but with a single dimension per metric
    const metricsWithDuplicates = flatMap(metricTemplates, metricSet => {
        const dimensions = metricSet.dimensions.map(d => d.dimensionName);
        return metricSet.metrics.map(metric => ({
            namespace: metricSet.namespace,
            dimensions,
            metricName: metric.name,
            defaultStat: metric.defaultStat,
        }));
    });
    // Then combine the dimensions for the same metrics into a single list
    return groupBy(metricsWithDuplicates, m => `${m.namespace}/${m.metricName}`).map(metrics => ({
        namespace: metrics[0].namespace,
        metricName: metrics[0].metricName,
        defaultStat: metrics[0].defaultStat,
        dimensions: Array.from(dedupeStringLists(metrics.map(m => m.dimensions))),
    }));
}
exports.cannedMetricsForService = cannedMetricsForService;
let cannedMetricsCache;
/**
 * Load the canned metrics file and process it into an index, grouped by service namespace
 */
function cannedMetricsIndex() {
    if (cannedMetricsCache === undefined) {
        cannedMetricsCache = {};
        for (const group of (0, canned_metrics_schema_1.loadCannedMetricsFile)()) {
            for (const metricTemplate of group.metricTemplates) {
                const [aws, service] = metricTemplate.resourceType.split('::');
                const serviceKey = [aws, service].join('::');
                (cannedMetricsCache[serviceKey] ?? (cannedMetricsCache[serviceKey] = [])).push(metricTemplate);
            }
        }
    }
    return cannedMetricsCache;
}
function flatMap(xs, fn) {
    return Array.prototype.concat.apply([], xs.map(fn));
}
function groupBy(xs, keyFn) {
    const obj = {};
    for (const x of xs) {
        const key = keyFn(x);
        if (key in obj) {
            obj[key].push(x);
        }
        else {
            obj[key] = [x];
        }
    }
    return Object.values(obj);
}
function* dedupeStringLists(xs) {
    const seen = new Set();
    for (const x of xs) {
        x.sort();
        const key = `${x.join(',')}`;
        if (!seen.has(key)) {
            yield x;
        }
        seen.add(key);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FubmVkLW1ldHJpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYW5uZWQtbWV0cmljcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxrRkFBK0Y7QUE0Qy9GOztHQUVHO0FBQ0gsU0FBZ0IsdUJBQXVCLENBQUMsdUJBQStCO0lBQ3JFLDhFQUE4RTtJQUM5RSxnRkFBZ0Y7SUFDaEYsTUFBTSxlQUFlLEdBQUcsa0JBQWtCLEVBQUUsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUU1RSw4RUFBOEU7SUFDOUUsTUFBTSxxQkFBcUIsR0FBRyxPQUFPLENBQUMsZUFBZSxFQUFFLFNBQVMsQ0FBQyxFQUFFO1FBQ2pFLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xFLE9BQU8sU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3RDLFNBQVMsRUFBRSxTQUFTLENBQUMsU0FBUztZQUM5QixVQUFVO1lBQ1YsVUFBVSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1lBQ3ZCLFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVztTQUNoQyxDQUFDLENBQUMsQ0FBQztJQUNOLENBQUMsQ0FBQyxDQUFDO0lBRUgsc0VBQXNFO0lBQ3RFLE9BQU8sT0FBTyxDQUFDLHFCQUFxQixFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDM0YsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQy9CLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVTtRQUNqQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVc7UUFDbkMsVUFBVSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFRO0tBQ2pGLENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQXZCRCwwREF1QkM7QUFJRCxJQUFJLGtCQUFrRCxDQUFDO0FBRXZEOztHQUVHO0FBQ0gsU0FBUyxrQkFBa0I7SUFDekIsSUFBSSxrQkFBa0IsS0FBSyxTQUFTLEVBQUU7UUFDcEMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBQSw2Q0FBcUIsR0FBRSxFQUFFO1lBQzNDLEtBQUssTUFBTSxjQUFjLElBQUksS0FBSyxDQUFDLGVBQWUsRUFBRTtnQkFDbEQsTUFBTSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0QsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM3QyxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDaEc7U0FDRjtLQUNGO0lBQ0QsT0FBTyxrQkFBa0IsQ0FBQztBQUM1QixDQUFDO0FBRUQsU0FBUyxPQUFPLENBQU8sRUFBTyxFQUFFLEVBQWlCO0lBQy9DLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDdEQsQ0FBQztBQUVELFNBQVMsT0FBTyxDQUFJLEVBQU8sRUFBRSxLQUF1QjtJQUNsRCxNQUFNLEdBQUcsR0FBcUMsRUFBRSxDQUFDO0lBQ2pELEtBQUssTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ2xCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyQixJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQUU7WUFDZCxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2xCO2FBQU07WUFDTCxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNoQjtLQUNGO0lBQ0QsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVCLENBQUM7QUFFRCxRQUFRLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFjO0lBQ3hDLE1BQU0sSUFBSSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7SUFDL0IsS0FBSyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUU7UUFDbEIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1QsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDbEIsTUFBTSxDQUFDLENBQUM7U0FDVDtRQUNELElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDZjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2FkQ2FubmVkTWV0cmljc0ZpbGUsIE1ldHJpY1RlbXBsYXRlIH0gZnJvbSAnLi9jYW5uZWQtbWV0cmljcy9jYW5uZWQtbWV0cmljcy1zY2hlbWEnO1xuXG5leHBvcnQgdHlwZSBOb25FbXB0eUFycmF5PFQ+ID0gW1QsIC4uLlRbXV07XG5cbi8qKlxuICogQSBzaW5nbGUgY2FubmVkIHNlcnZpY2UgbWV0cmljXG4gKlxuICogVGhlc2UgYXJlIGtpbmRseSBwcm92aWRlZCB0byB1cyBieSB0aGUgZ29vZCBwZW9wbGUgb2YgQ2xvdWRXYXRjaCBFeHBsb3Jlci5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDYW5uZWRNZXRyaWMge1xuICAvKipcbiAgICogTWV0cmljIG5hbWVzcGFjZVxuICAgKi9cbiAgcmVhZG9ubHkgbmFtZXNwYWNlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIE1ldHJpYyBuYW1lXG4gICAqL1xuICByZWFkb25seSBtZXRyaWNOYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIExpc3Qgb2YgYWxsIHBvc3NpYmxlIGRpbWVuc2lvbiBwZXJtdXRhdGlvbnMgZm9yIHRoaXMgbWV0cmljXG4gICAqXG4gICAqIE1vc3QgbWV0cmljcyB3aWxsIGhhdmUgYSBzaW5nbGUgbGlzdCBvZiBzdHJpbmdzIGFzIHRoZWlyIG9uZSBzZXQgb2ZcbiAgICogYWxsb3dlZCBkaW1lbnNpb25zLCBidXQgc29tZSBtZXRyaWNzIGFyZSBlbWl0dGVkIHVuZGVyIG11bHRpcGxlXG4gICAqIGNvbWJpbmF0aW9ucyBvZiBkaW1lbnNpb25zLlxuICAgKi9cbiAgcmVhZG9ubHkgZGltZW5zaW9uczogTm9uRW1wdHlBcnJheTxzdHJpbmdbXT47XG5cbiAgLyoqXG4gICAqIFN1Z2dlc3RlZCBkZWZhdWx0IGFnZ3JlZ3JhdGlvbiBzdGF0aXN0aWNcbiAgICpcbiAgICogTm90IGFsd2F5cyB0aGUgbW9zdCBhcHByb3ByaWF0ZSBvbmUgdG8gdXNlISBUaGVzZSBkZWZhdWx0cyBoYXZlXG4gICAqIGJlZW4gY2xhc3NpZmllZCBieSBwZW9wbGUgYW5kIHRoZXkgZ2VuZXJhbGx5IGp1c3QgcGljayBcIkF2ZXJhZ2VcIlxuICAgKiBhcyB0aGUgZGVmYXVsdCwgZXZlbiBpZiBpdCBkb2Vzbid0IG1ha2Ugc2Vuc2UuXG4gICAqXG4gICAqIEZvciBleGFtcGxlOiBmb3IgZXZlbnQtYmFzZWQgbWV0cmljcyB0aGF0IG9ubHkgZXZlciBlbWl0IGAxYFxuICAgKiAoYW5kIG5ldmVyIGAwYCkgdGhlIGJldHRlciBzdGF0aXN0aWMgd291bGQgYmUgYFN1bWAuXG4gICAqXG4gICAqIFVzZSB5b3VyIGp1ZGdlbWVudCBiYXNlZCBvbiB0aGUgdHlwZSBvZiBtZXRyaWMgdGhpcyBpcy5cbiAgICovXG4gIHJlYWRvbmx5IGRlZmF1bHRTdGF0OiBzdHJpbmc7XG59XG5cbi8qKlxuICogUmV0dXJuIHRoZSBsaXN0IG9mIGNhbm5lZCBtZXRyaWNzIGZvciB0aGUgZ2l2ZW4gc2VydmljZVxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FubmVkTWV0cmljc0ZvclNlcnZpY2UoY2xvdWRGb3JtYXRpb25OYW1lc3BhY2U6IHN0cmluZyk6IENhbm5lZE1ldHJpY1tdIHtcbiAgLy8gT25lIG1ldHJpY1RlbXBsYXRlIGhhcyBhIHNpbmdsZSBzZXQgb2YgZGltZW5zaW9ucywgYnV0IHRoZSBzYW1lIG1ldHJpYyBOQU1FXG4gIC8vIG1heSBvY2N1ciBpbiBtdWx0aXBsZSBtZXRyaWNUZW1wbGF0ZXMgKGlmIGl0IGhhcyBtdWx0aXBsZSBzZXRzIG9mIGRpbWVuc2lvbnMpXG4gIGNvbnN0IG1ldHJpY1RlbXBsYXRlcyA9IGNhbm5lZE1ldHJpY3NJbmRleCgpW2Nsb3VkRm9ybWF0aW9uTmFtZXNwYWNlXSA/PyBbXTtcblxuICAvLyBGaXJzdCBjb25zdHJ1Y3QgYWxtb3N0IHdoYXQgd2UgbmVlZCwgYnV0IHdpdGggYSBzaW5nbGUgZGltZW5zaW9uIHBlciBtZXRyaWNcbiAgY29uc3QgbWV0cmljc1dpdGhEdXBsaWNhdGVzID0gZmxhdE1hcChtZXRyaWNUZW1wbGF0ZXMsIG1ldHJpY1NldCA9PiB7XG4gICAgY29uc3QgZGltZW5zaW9ucyA9IG1ldHJpY1NldC5kaW1lbnNpb25zLm1hcChkID0+IGQuZGltZW5zaW9uTmFtZSk7XG4gICAgcmV0dXJuIG1ldHJpY1NldC5tZXRyaWNzLm1hcChtZXRyaWMgPT4gKHtcbiAgICAgIG5hbWVzcGFjZTogbWV0cmljU2V0Lm5hbWVzcGFjZSxcbiAgICAgIGRpbWVuc2lvbnMsXG4gICAgICBtZXRyaWNOYW1lOiBtZXRyaWMubmFtZSxcbiAgICAgIGRlZmF1bHRTdGF0OiBtZXRyaWMuZGVmYXVsdFN0YXQsXG4gICAgfSkpO1xuICB9KTtcblxuICAvLyBUaGVuIGNvbWJpbmUgdGhlIGRpbWVuc2lvbnMgZm9yIHRoZSBzYW1lIG1ldHJpY3MgaW50byBhIHNpbmdsZSBsaXN0XG4gIHJldHVybiBncm91cEJ5KG1ldHJpY3NXaXRoRHVwbGljYXRlcywgbSA9PiBgJHttLm5hbWVzcGFjZX0vJHttLm1ldHJpY05hbWV9YCkubWFwKG1ldHJpY3MgPT4gKHtcbiAgICBuYW1lc3BhY2U6IG1ldHJpY3NbMF0ubmFtZXNwYWNlLFxuICAgIG1ldHJpY05hbWU6IG1ldHJpY3NbMF0ubWV0cmljTmFtZSxcbiAgICBkZWZhdWx0U3RhdDogbWV0cmljc1swXS5kZWZhdWx0U3RhdCxcbiAgICBkaW1lbnNpb25zOiBBcnJheS5mcm9tKGRlZHVwZVN0cmluZ0xpc3RzKG1ldHJpY3MubWFwKG0gPT4gbS5kaW1lbnNpb25zKSkpIGFzIGFueSxcbiAgfSkpO1xufVxuXG50eXBlIENhbm5lZE1ldHJpY3NJbmRleCA9IFJlY29yZDxzdHJpbmcsIE1ldHJpY1RlbXBsYXRlW10+O1xuXG5sZXQgY2FubmVkTWV0cmljc0NhY2hlOiBDYW5uZWRNZXRyaWNzSW5kZXggfCB1bmRlZmluZWQ7XG5cbi8qKlxuICogTG9hZCB0aGUgY2FubmVkIG1ldHJpY3MgZmlsZSBhbmQgcHJvY2VzcyBpdCBpbnRvIGFuIGluZGV4LCBncm91cGVkIGJ5IHNlcnZpY2UgbmFtZXNwYWNlXG4gKi9cbmZ1bmN0aW9uIGNhbm5lZE1ldHJpY3NJbmRleCgpIHtcbiAgaWYgKGNhbm5lZE1ldHJpY3NDYWNoZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgY2FubmVkTWV0cmljc0NhY2hlID0ge307XG4gICAgZm9yIChjb25zdCBncm91cCBvZiBsb2FkQ2FubmVkTWV0cmljc0ZpbGUoKSkge1xuICAgICAgZm9yIChjb25zdCBtZXRyaWNUZW1wbGF0ZSBvZiBncm91cC5tZXRyaWNUZW1wbGF0ZXMpIHtcbiAgICAgICAgY29uc3QgW2F3cywgc2VydmljZV0gPSBtZXRyaWNUZW1wbGF0ZS5yZXNvdXJjZVR5cGUuc3BsaXQoJzo6Jyk7XG4gICAgICAgIGNvbnN0IHNlcnZpY2VLZXkgPSBbYXdzLCBzZXJ2aWNlXS5qb2luKCc6OicpO1xuICAgICAgICAoY2FubmVkTWV0cmljc0NhY2hlW3NlcnZpY2VLZXldID8/IChjYW5uZWRNZXRyaWNzQ2FjaGVbc2VydmljZUtleV0gPSBbXSkpLnB1c2gobWV0cmljVGVtcGxhdGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gY2FubmVkTWV0cmljc0NhY2hlO1xufVxuXG5mdW5jdGlvbiBmbGF0TWFwPEEsIEI+KHhzOiBBW10sIGZuOiAoeDogQSkgPT4gQltdKTogQltdIHtcbiAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5jb25jYXQuYXBwbHkoW10sIHhzLm1hcChmbikpO1xufVxuXG5mdW5jdGlvbiBncm91cEJ5PEE+KHhzOiBBW10sIGtleUZuOiAoeDogQSkgPT4gc3RyaW5nKTogQXJyYXk8Tm9uRW1wdHlBcnJheTxBPj4ge1xuICBjb25zdCBvYmo6IFJlY29yZDxzdHJpbmcsIE5vbkVtcHR5QXJyYXk8QT4+ID0ge307XG4gIGZvciAoY29uc3QgeCBvZiB4cykge1xuICAgIGNvbnN0IGtleSA9IGtleUZuKHgpO1xuICAgIGlmIChrZXkgaW4gb2JqKSB7XG4gICAgICBvYmpba2V5XS5wdXNoKHgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvYmpba2V5XSA9IFt4XTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIE9iamVjdC52YWx1ZXMob2JqKTtcbn1cblxuZnVuY3Rpb24qIGRlZHVwZVN0cmluZ0xpc3RzKHhzOiBzdHJpbmdbXVtdKTogSXRlcmFibGVJdGVyYXRvcjxzdHJpbmdbXT4ge1xuICBjb25zdCBzZWVuID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIGZvciAoY29uc3QgeCBvZiB4cykge1xuICAgIHguc29ydCgpO1xuICAgIGNvbnN0IGtleSA9IGAke3guam9pbignLCcpfWA7XG4gICAgaWYgKCFzZWVuLmhhcyhrZXkpKSB7XG4gICAgICB5aWVsZCB4O1xuICAgIH1cbiAgICBzZWVuLmFkZChrZXkpO1xuICB9XG59Il19